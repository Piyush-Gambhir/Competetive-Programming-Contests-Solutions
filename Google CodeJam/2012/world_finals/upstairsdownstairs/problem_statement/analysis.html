
<html>
  <head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/external_hosted/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML,Safe"></script>
    <script>
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
          inlineMath: [ ['$$$','$$$'] ],
          displayMath: [ ['$$$$','$$$$'] ],
          skipTags: ["script","noscript","style","textarea","pre"],  // allow <code>.
          processEscapes: true
        },
        showProcessingMessages: false,
        messageStyle: "none",
        "HTML-CSS": { scale: 90, fonts: ["TeX"] }
      });
      MathJax.Ajax.loadComplete('https://codingcompetitions.withgoogle.com/static/mathjax-config.js');
      </script>
    <style>
.problem-io-wrapper-new .sampleio-wrapper {
  display: flex;
  flex-direction: row;
  align-items: stretch;
  justify-content: flex-start;
  margin-top: 1rem;
  padding-left: 12.5px;
  padding-right: 12.5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-input {
  display: flex;
  flex-direction: column;
  flex: 1 1 0px;
  margin-left: -12.5px;
  margin-right: 12.5px;
  max-width: 50%;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-output {
  display: flex;
  flex-direction: column;
  flex: 1 1 0px;
  margin-left: 12.5px;
  margin-right: -12.5px;
  max-width: 50%;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-text {
  flex: 1;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-download-button {
  display: none;
  cursor: pointer;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button {
  display: none;
  cursor: pointer;
  position: relative;
  margin-left: 5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup {
  visibility: hidden;
  width: 100px;
  background-color: #999;
  color: #fff;
  text-align: center;
  border-radius: 3px;
  padding: 4px 0;
  position: absolute;
  z-index: 1;
  top: 125%;
  left: 50%;
  margin-left: -50px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup::before {
  content: "";
  position: absolute;
  bottom: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: transparent transparent #999 transparent;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup-shown {
  visibility: visible;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button-hidden {
  display: none;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-content {
  display: flex;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #f5f5f5;
  padding: 9.5px 9.5px 0px 9.5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-content .sample-content-text {
  flex-grow: 1;
  margin: 0px;
  overflow-x: auto;
  padding-bottom: 9.5px;
  line-height: normal;
  white-space: pre-wrap;
}
.test-data-download-wrapper {
  display: none;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  width: fit-content;
  max-width: 600px;
  margin-top: 1rem;
}
.test-data-download-wrapper .test-data-download-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.test-data-download-wrapper .test-data-download-header .test-data-download-header-text {
  flex: 1;
}
.test-data-download-wrapper .test-data-download-header .test-data-download-header-download-button {
  display: none;
  cursor: pointer;
}
.test-data-download-wrapper .test-data-download-content {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #f5f5f5;
  padding: 9.5px 9.5px 9.5px 9.5px;
}
.sample-interaction-wrapper {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  max-width: 600px;
  margin-top: 1rem;
}
.sample-interaction-wrapper .sample-interaction-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.sample-interaction-wrapper .sample-interaction-header .sample-interaction-text {
  flex: 1;
}
.sample-interaction-wrapper .sample-interaction-content {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #e6e6e6;
  padding: 9.5px 9.5px 9.5px 9.5px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels {
  display: flex;
  flex-direction: row;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels .sample-interaction-judge-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: left;
  flex-grow: 1;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels .sample-interaction-solution-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: right;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper {
  display: flex;
  flex-direction: row;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper .sample-interaction-judge-output-box {
  text-align: start;
  background: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 4px 8px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper .sample-interaction-judge-output-box .sample-interaction-judge-output-test {
  margin: 0;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper {
  display: flex;
  flex-direction: row-reverse;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper .sample-interaction-solution-output-box {
  text-align: start;
  background: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 4px 8px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper .sample-interaction-solution-output-box .sample-interaction-solution-output-test {
  margin: 0;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-note {
  font-style: italic;
  color: #4e4e4e;
  margin-right: 20%;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-note {
  font-style: italic;
  color: #4e4e4e;
  margin-left: 20%;
  text-align: end;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-block-section-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: center;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-block-spacer {
  height: 9.5px;
}
    </style>
  </head>
  <body>
    <div>
<h3>Code Jam 2012 - World Finals</h3><h1>Analysis: Upstairs/Downstairs</h1><p>
Upstairs/Downstairs was a last-minute addition to the Finals, replacing a year-old problem proposal that had appeared on a separate contest two months before.  This problem loosely mirrors an experience the author had once while on vacation.  He was downstairs.
</p>

<p>
Solving this problem involves two observations and an algorithm.  Before making our observations, let's start by writing out the formula for the quantity we want to minimize.  <code>p<sub>i</sub></code> will represent the probability that the <code>i<sup>th</sup></code> activity Konstantin performs will result in Ilia being awake:<br/>
<code>
P(woken up) =<br/>
  (1-p<sub>0</sub>) * (1 - (1-p<sub>1</sub>)(1-p<sub>2</sub>)*...* (1 - p<sub>K</sub>)) +<br/>
  p<sub>0</sub>(1-p<sub>1</sub>) * (1 - (1-p<sub>2</sub>)(1-p<sub>3</sub>)*...*(1 - p<sub>K</sub>)) +<br/>
  p<sub>0</sub>p<sub>1</sub>(1-p<sub>2</sub>) * (1 - (1-p<sub>3</sub>)(1-p<sub>4</sub>)*...*(1 - p<sub>K</sub>)) +<br/>
  ...
</code>
</p>
<h3>Observation 1: Noisy First</h3>
<p>
For our first observation, we'll look for a reason to prefer that Konstantin perform noisier or quieter activities earlier.  Intuitively, we suspect that noisier activities should come first: a strategy that keeps Ilia awake and then tries to keep him asleep seems pretty reasonable.
</p>
<p>
Looking at the structure of the formula above, we can look for differences between how <code>p<sub>i</sub></code> and <code>p<sub>i+1</sub></code> are used.  Here are the terms in which swapping them would lead to a difference in the final result:<br/>
<code>
p<sub>0</sub>p<sub>1</sub>...p<sub>i-1</sub>(1-p<sub>i</sub>) * (1 - (1-p<sub>i+1</sub>)(1-p<sub>i+2</sub>)*...*(1 - p<sub>K</sub>)) +<br/>
p<sub>0</sub>p<sub>1</sub>...p<sub>i-1</sub>p<sub>i</sub>(1-p<sub>i+1</sub>) * (1 - (1-p<sub>i+2</sub>)*...*(1 - p<sub>K</sub>))<br/>
</code>
Simplifying these two terms, we have:<br/>
<code>
p<sub>0</sub>p<sub>1</sub>...p<sub>i-1</sub> * [<br/>
&nbsp;&nbsp;(1-p<sub>i</sub>) + p<sub>i</sub>(1-p<sub>i+1</sub>) -<br/>
&nbsp;&nbsp;(1-p<sub>i</sub>)(1-p<sub>i+1</sub>)...(1-p<sub>K</sub>) -<br/>
&nbsp;&nbsp;p<sub>i</sub>(1-p<sub>i+1</sub>)...(1-p<sub>K</sub>)]<br/>
= p<sub>0</sub>p<sub>1</sub>...p<sub>i-1</sub> * [1 - p<sub>i</sub>p<sub>i+1</sub> - (1 - p<sub>i+1</sub>)(1 - p<sub>i+2</sub>)...(1 - p<sub>K</sub>)]<br/>
</code>
This quantity is minimized by choosing <code>p<sub>i+1</sub> &lt; p<sub>i</sub></code>, which confirms the intuition that noisier activities should happen earlier.  Repeatedly swapping adjacent activities like this shows that in an optimal solution, activities should be performed from noisiest to quietest.
</p>

<h3>Observation 2: Go Extreme!</h3>
<p>
Our original formula for <code>P(woken up)</code> is clearly linear in <code>p<sub>i</sub></code> for all <code>i</code>.  This quantity therefore must be minimized by taking either the largest possible value or the smallest possible value for <code>p<sub>i</sub></code>.
</p>
<p>
Putting this observation together with the previous one, we can conclude that Konstantin should start by performing the <code>K-q</code> noisiest activities in order from noisiest to quietest, and then should perform the <code>q</code> quietest activities, also in order from noisiest to quietest.  We'll call the first set of activities the <i>prefix</i>, and the others the <i>suffix</i>.  Note that here we're considering an activity that can be repeated <code>c</code> times as <code>c</code> different activities.
</p>

<h3>Possible Algorithms</h3>
<p>
For the Small, it's sufficient to try all values of <code>q</code>.  There are <code>O(K)</code> possible values, and evaluating each one naively takes <code>O(sum(c<sub>i</sub>))</code> time, so the running time is <code>O(sum(c<sub>i</sub>)<sup>2</sup>)</code>.
</p>
<p>
There are only two numbers we really need to keep track of for each possible suffix: the probability that Ilia will end up being woken up if he starts the suffix awake, and the probability that he will end up being woken up if he starts the suffix asleep.  After precomputing those 2 values for each of the K possible suffixes, which we can do in <code>O(K)</code> time, we can simulate each possible prefix, also in <code>O(K)</code> time, and do a quick lookup for the corresponding suffix for each one.  A little math produces the correct answer, in <code>O(sum(c<sub>i</sub>))</code> time.
</p>
<p>
Another algorithm that boils down to the same thing involves treating Ilia's three states&mdash;awake, asleep, and woken up&mdash;as a 3x1 vector that can be operated on by matrices.  For any activity, we can build a 3x3 <a href="http://en.wikipedia.org/wiki/Transition_matrix" target="_blank">transition matrix</a>, looking like this:<br/>
<pre>[[p    0    0]
 [1-p  1-p  0]
 [<b>0</b>    <b>p</b>    1]]</pre>
Ilia's initial state is:<br/>
<pre>[1
 0
 0]</pre>
To build the transition matrix for a series of activities, we can multiply the activities' matrices together, with the noisiest activity on the right.  In this way, we can compute a 3x3 matrix corresponding to each prefix of length up to K, and one for each suffix of length up to K, in <code>O(K)</code> time.  Then it's an <code>O(1)</code> operation to check the result for any given prefix/suffix pair: multiplying those two matrices by each other, then by Ilia's initial state.  The algorithm ends up taking <code>O(sum(c<sub>i</sub>))</code> time.
</p>
<p>
Note that the bolded entries of the transition matrix, above, correspond to the two numbers we cared about for each suffix in the previous algorithm.
</p>

<h4>Ternary Search Passed Test Cases, But...</h4>

<p>
Because this problem was prepared at the last minute, it didn't occur to us until during the contest to wonder whether ternary search would work for selecting <code>q</code>, the length of the suffix.  We would have been happy with the answer either way, but we would have wanted test data that would break ternary search if the answer turned out to be "no".
</p>

<p>It turned out that the answer <i>was</i> "no", and that none of our existing cases broke any ternary search that we found.  Because of this, some contestants&mdash;most notably <b>misof</b>, who came third partly on the strength of the points he got from this problem&mdash;managed to submit ternary search solutions that passed our test data.
</p>

<p>
Sometimes it happens in Code Jam that contestants will come up with algorithms that don't work in general given the limits we've provided, but do work on our test data.  We try to avoid situations of that sort, but they do happen.  We think the consequences here weren't significant, for a few reasons: Implementing the ternary search is about as hard as implementing a correct solution, if not a little harder; the "hard part" of the problem was already done by that point; and if we'd come up with a breaking case, we'd have put it in the Small data as well as the Large.  Contestants who implemented ternary search would have seen it was wrong in the Small, and taken the time to fix it.  <b>misof</b> had plenty of time separating him from the fourth-place contestant, so the top three likely would not have changed.
</p>

<h4>Why Ternary Search Fails</h4>

<p>
Ternary search seems like it should work.  Indeed, the function that we're minimizing, P(woken up), is strictly <i>non-increasing</i> and then strictly <i>non-decreasing</i> in <code>q</code>.  Unfortunately, that isn't quite enough: it needs to be strictly <i>decreasing</i> and then strictly <i>increasing</i>; otherwise a large constant patch will leave the ternary search unable to tell which direction it should go in.  
</p>
<p>
Here's an example case that breaks ternary search in principle, and breaks a few contestants' submissions in practice:<br/>
<code>
2<br/>
2 200<br/>
1/2 40<br/>
1/100 400<br/>
2 200<br/>
1/2 40<br/>
99/100 400
</code>
</p>
<p>
The correct answer is:<br/>
<code>
Case #1: 0.863976521<br/>
Case #2: 0.863976521
</code>
</p>
<p>
In the first case, the "1/2" activities are best not performed; but because they are at the very start of the list of activities, outnumbered severely by the "1/100" activities, a standard ternary search will find no difference between the two suffix lengths it tries.  It will merely consider a different number of "1/100" activities to be part of the suffix as opposed to the prefix, and leave all the "1/2" activities in place.  The second case is identical, but with "99/100" activities instead of "1/100" activities, which should defeat a ternary search that happens to choose the right direction in the first case.
</p>

<h4>Paweł i Gaweł</h4>

<p>
At dinner after the finals, several Polish contestants were shocked to discover that the problem was not based on a poem called <a href="http://pl.wikisource.org/wiki/Pawe%C5%82_i_Gawe%C5%82" target="_blank">Paweł i Gaweł</a>.  The similarity was entirely coincidental, as the contestants should have known: Gaweł, who (according to Google Translate's translation of that page) "invented the wildest frolics", lived <i>downstairs</i>.  Still, in retrospect, we wish we'd named the problem after that poem, and perhaps had Gaweł minimize the probability that Paweł would go fishing.
</p>

  <div class="test-data-download-wrapper">
    <div class="test-data-download-header">
      <div class="test-data-download-header-text">Test Data</div>
      <div class="test-data-download-header-download-button">
        <a href="test_data.zip" target="_blank">
          <i class="material-icons grey">save_alt</i>
        </a>
      </div>
    </div>
    <div class="test-data-download-content">
      <div class="test-data-download-warning">
        <span class="material-icons" style="color: grey; vertical-align: middle;">info</span>
        <span style="vertical-align: middle;">We recommend that you practice debugging solutions without looking at the test data.</span>
      </div>
    </div>
  </div>



    </div>
  </body>
</html>
