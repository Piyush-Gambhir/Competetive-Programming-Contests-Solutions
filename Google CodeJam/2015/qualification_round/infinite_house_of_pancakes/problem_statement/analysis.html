
<html>
  <head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/external_hosted/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML,Safe"></script>
    <script>
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
          inlineMath: [ ['$$$','$$$'] ],
          displayMath: [ ['$$$$','$$$$'] ],
          skipTags: ["script","noscript","style","textarea","pre"],  // allow <code>.
          processEscapes: true
        },
        showProcessingMessages: false,
        messageStyle: "none",
        "HTML-CSS": { scale: 90, fonts: ["TeX"] }
      });
      MathJax.Ajax.loadComplete('https://codingcompetitions.withgoogle.com/static/mathjax-config.js');
      </script>
    <style>
.problem-io-wrapper-new .sampleio-wrapper {
  display: flex;
  flex-direction: row;
  align-items: stretch;
  justify-content: flex-start;
  margin-top: 1rem;
  padding-left: 12.5px;
  padding-right: 12.5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-input {
  display: flex;
  flex-direction: column;
  flex: 1 1 0px;
  margin-left: -12.5px;
  margin-right: 12.5px;
  max-width: 50%;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-output {
  display: flex;
  flex-direction: column;
  flex: 1 1 0px;
  margin-left: 12.5px;
  margin-right: -12.5px;
  max-width: 50%;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-text {
  flex: 1;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-download-button {
  display: none;
  cursor: pointer;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button {
  display: none;
  cursor: pointer;
  position: relative;
  margin-left: 5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup {
  visibility: hidden;
  width: 100px;
  background-color: #999;
  color: #fff;
  text-align: center;
  border-radius: 3px;
  padding: 4px 0;
  position: absolute;
  z-index: 1;
  top: 125%;
  left: 50%;
  margin-left: -50px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup::before {
  content: "";
  position: absolute;
  bottom: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: transparent transparent #999 transparent;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup-shown {
  visibility: visible;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button-hidden {
  display: none;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-content {
  display: flex;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #f5f5f5;
  padding: 9.5px 9.5px 0px 9.5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-content .sample-content-text {
  flex-grow: 1;
  margin: 0px;
  overflow-x: auto;
  padding-bottom: 9.5px;
  line-height: normal;
  white-space: pre-wrap;
}
.test-data-download-wrapper {
  display: none;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  width: fit-content;
  max-width: 600px;
  margin-top: 1rem;
}
.test-data-download-wrapper .test-data-download-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.test-data-download-wrapper .test-data-download-header .test-data-download-header-text {
  flex: 1;
}
.test-data-download-wrapper .test-data-download-header .test-data-download-header-download-button {
  display: none;
  cursor: pointer;
}
.test-data-download-wrapper .test-data-download-content {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #f5f5f5;
  padding: 9.5px 9.5px 9.5px 9.5px;
}
.sample-interaction-wrapper {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  max-width: 600px;
  margin-top: 1rem;
}
.sample-interaction-wrapper .sample-interaction-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.sample-interaction-wrapper .sample-interaction-header .sample-interaction-text {
  flex: 1;
}
.sample-interaction-wrapper .sample-interaction-content {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #e6e6e6;
  padding: 9.5px 9.5px 9.5px 9.5px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels {
  display: flex;
  flex-direction: row;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels .sample-interaction-judge-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: left;
  flex-grow: 1;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels .sample-interaction-solution-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: right;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper {
  display: flex;
  flex-direction: row;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper .sample-interaction-judge-output-box {
  text-align: start;
  background: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 4px 8px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper .sample-interaction-judge-output-box .sample-interaction-judge-output-test {
  margin: 0;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper {
  display: flex;
  flex-direction: row-reverse;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper .sample-interaction-solution-output-box {
  text-align: start;
  background: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 4px 8px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper .sample-interaction-solution-output-box .sample-interaction-solution-output-test {
  margin: 0;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-note {
  font-style: italic;
  color: #4e4e4e;
  margin-right: 20%;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-note {
  font-style: italic;
  color: #4e4e4e;
  margin-left: 20%;
  text-align: end;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-block-section-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: center;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-block-spacer {
  height: 9.5px;
}
    </style>
  </head>
  <body>
    <div>
<h3>Code Jam 2015 - Qualification Round</h3><h1>Analysis: Infinite House of Pancakes</h1><p>As the head server, you have two choices for each minute:
<ol>
<li><b>eat</b>: you do nothing and let every diner with a non-empty plate eat one pancake from his or her plate.</li>
<li><b>move</b>: you ask for the diners' attention for a <i>special</i> minute, choose a diner with a non-empty plate, and move some number of pancakes from that diner's plate to another diner's (empty or non-empty) plate.</li></ol>
</p>

<p>Imagine that you, as the head server, have planned a strategy to move the pancakes. Let&#39;s call it <b>strategy A</b>. In this strategy, you pick a successive pair of minutes <b>t</b> and <b>t+1</b> such that at minute <b>t</b> you choose <b>eat</b> and at minute <b>t+1</b> you choose <b>move</b>. As a natural philosopher, you start to question your decision, &quot;What if I swap my plan at minute <b>t</b> with my plan at minute <b>t+1</b>, i.e. <b>move</b> pancakes at minute <b>t</b> (instead of <b>t+1</b>) and <b>eat</b> at minute <b>t+1</b> (instead of <b>t</b>)?&quot;. Out of curiosity, you swap your plan at minute <b>t</b> and <b>t+1</b> and calculate the breakfast end time. Surprisingly, breakfast does not take longer. After that, you start to find several other successive pairs of minutes with the same property and do other swaps. You find that breakfast never takes longer than if you strictly follow <b>strategy A</b>. Surprisingly, on certain swaps, breakfast even ends earlier than <b>strategy A</b>!</p>

<p>Of course you become more curious! You start to observe what happened when you did those swaps. If the plan at minute <b>t</b> is <b>eat</b> and the plan at minute <b>t+1</b> is <b>move</b>, you notice that all pancakes that were eaten at time <b>t</b> before you did the swap were also eaten at time <b>t+1</b> after swapping. Hence, the number of pancakes that were eaten after time <b>t+1</b> does not decrease, which implies that breakfast will not take longer. After you swap the plan at <b>t</b> with <b>t+1</b>, you notice that several plates that were empty at time <b>t</b> might become non-empty at time <b>t+1</b> after swapping (and hence, the number of pancakes that were eaten after time <b>t+1</b> might increase by one).</p>

<blockquote> &quot;Whoa! That means if I swap <b>&lt;eat, move&gt;</b> pairs to <b>&lt;move, eat&gt;</b>, the amount of pancakes that were eaten at time <b>t</b> before the swap is either less than or equal to the amount of pancakes that were eaten at time <b>t+1</b> after the swap. Hence, such swaps are always good (i.e. it will not make the  breakfast time longer but might make the breakfast time shorter)!&quot;</blockquote>

<p>Excited with your finding, you grab a whiteboard and start to swap every successive pairs of <b>&lt;eat, move&gt;</b> to be <b>&lt;move, eat&gt;</b>, until none of the <b>&lt;eat, move&gt;</b> pairs are left. You look at your revised strategy.

<blockquote>&quot;<b>Move, move, move, eat, eat, eat, eat, eat</b>&quot; you read out loudly. &quot;Of course! <i>The only strategy without a <b>&lt;eat, move&gt;</b> pair is the strategy in which we do all the moves at the beginning, and always eat after that</i>. If we look at this carefully, swapping pairs of elements that are in the wrong order (in this case <b>eat</b> then <b>move</b>) until none are left will actually <i>sort</i> the strategy. This is basically doing <a href="http://en.wikipedia.org/wiki/Bubble_sort" target="_blank">bubble sort</a> on <b>strategy A</b>!&quot;</p></blockquote>

<p>Knowing that you are going to get a bonus from your boss for ending breakfast early, you quickly present this solution to your boss. Your boss is not convinced. He replies without showing much interest, &quot;Well, I understand that <b>moving</b> pancakes at the beginning will always lead to an optimal solution. But what is more important is that for every <b>move</b>, do you know how you are going to move the pancakes?&quot; You quickly answer, &quot;At least I know that we can always move pancakes to empty plates! There are infinitely many of them, and we do not have any reason to let diners with non-empty plates to eat more than is needed. We cannot even wait for them to finish their existing pancakes!&quot;</p>

<p>Your boss stops reading emails and starts to pay attention to your explanation. &quot;How will you pick the plates to <b>move</b> pancakes from?&quot; he asks. &quot;Perhaps from the customer with the most pancakes on their plate? They need the most help to finish their pancakes,&quot; you reply.</p>

<blockquote>&quot;You mean we can end breakfast earlier if we keep moving several pancakes from the plates with most pancakes to empty plates, and stop moving after several minutes?&quot; he enthusiastically says. &quot;Congratulations! You get a big bonus and extra time off!&quot;</blockquote>

<p>You are extremely happy. You gather all the kitchen staff and explain the new strategy... of course after bragging a bit on social media! A new intern staff raises her hand and asks, &quot;When should we stop <b>moving</b> pancakes? Also, how many pancakes should we move every time?&quot;</p>

<p>The whole kitchen goes silent. Everyone is looking at you expecting answers. Breakfast will start in half an hour. &quot;Quick, think of something useful,&quot; you tell yourself. Your mind feels like it is exploding!</p>

<p>&quot;Erm, honestly I don&#39;t know. Let&#39;s try to simulate breakfast to get some insights. Please bring me two plates of pancakes with <b>15</b> and <b>17</b> pancakes respectively. Ah, don&#39;t forget to bring me several empty plates too,&quot; you order one of your staff.</p>

<p>You start to simulate your new strategy multiple times with different amount of pancakes to be moved and stop moving at different times. Suddenly, your new intern says to you, &quot;Look! You take <b>10</b> pancakes from the <b>plate 1</b> and put it on an <b>empty plate 3</b>. Later, you picked <b>3</b> pancakes from <b>plate 3</b> and moved it to another <b>empty plate 4</b>. Instead of doing that, why didn&#39;t you move <b>7</b> pancakes from first plate to an <b>empty plate 3</b>, and then move <b>3</b> pancakes from first plate to another <b>empty plate 4</b>? That way, you can always move pancakes from plates that are initially non-empty.&quot;</p>

<blockquote>&quot;I see,&quot; you say, &quot;That means we can take half the pancakes from the plate with largest amount of pancakes, then move it to an empty plate, then pick another plate with the largest amount of pancakes and do the same thing multiple times...&quot;</blockquote>

<blockquote>She replies quickly, &quot;Your strategy is bad. Imagine that you had a plate of <b>9</b> pancakes. If we use your strategy, the best we can do is to split the plate into plates with <b>4</b> and <b>5</b> pancakes, and let the diners eat them. It costs us <b>6</b> minutes to end breakfast. But if you split the plate into three plates with <b>3</b> pancakes each (using <b>2 moves</b>), we can finish breakfast in only <b>5</b> minutes!&quot;</blockquote>

<p>&quot;I have a suggestion,&quot; she continues, &quot;If you expect the customer to finish their pancakes <b>x</b> minutes after you stop moving pancakes, any strategy that satisfies this will be equivalent to repeatedly moving at most <b>x</b> pancakes from every initially non-empty plate to an empty plate until the number of pancakes on the initially non-empty plate becomes no more than <b>x</b>.&quot;</p>

<p>&quot;And if you always move exactly <b>x</b> pancakes, for a plate with <b>P<sub>i</sub></b> pancakes you need only <b>M(P<sub>i</sub>)=ceil(P<sub>i</sub>/x)-1</b> moves until the number of pancakes in the plate is no more than <b>x</b>. You cannot do less than that! Overall, we are going to move <b>sum of M(P<sub>i</sub>)</b> times, where <b>P<sub>i</sub></b> is the number of pancakes on <b>plate i</b>. That is the minimum amount of moves that we can do for the given <b>x</b>! We can try all possible values of <b>x</b> to find the optimal <b>x</b> that has earliest breakfast end time!&quot; Everyone gives her a standing ovation.</p>

<blockquote>&quot;Let&#39;s summarize our strategy. First of all, we fix a number <b>x</b> to be the number of minutes that we expect breakfast to end in after we stop moving pancakes. After that, we pick a plate with more than <b>x</b> pancakes, take <b>x</b> pancakes from that plate and move the pancakes to an empty plate. We keep doing that until all plates has at most <b>x</b> pancakes, then we let the customers eat their pancakes and breakfast ends the earliest for that <b>x</b> value! If we move <b>sum of M(P<sub>i</sub>)</b> times, in total, the breakfast ends exactly after <b>x + sum of M(P<sub>i</sub>)</b> minutes,&quot; you say. &quot;And we can try all possible values of <b>x</b>, since the amount of pancakes cannot be more than <b>1000</b>. The complexity of the algorithm is <b>O(D*M)</b>, where <b>D</b> is the number of diners and <b>M</b> is the maximum number of pancakes. This is fast enough to solve our problem. We can use a spreadsheet to...&quot;</blockquote>

<p>&quot;Certainly, but I have prepared for this,&quot; says your intern. She opens her laptop and types some really short functions, of course in <b>C++</b>. &quot;Why? Because <b>C++</b> is cool!&quot;</p>

<pre>
// Get the minimum possible breakfast end time, given 
// P[i] is the number of pancakes of diner i initially.
int f(const vector&lt;int&gt;&amp; P) {
  const int max_pancakes = *max_element(P.begin(), P.end());
  int ret = max_pancakes;
  for (int x = 1; x &lt; max_pancakes; ++x) {
    int total_moves = 0;
    for (const int Pi : P) {
      // (Pi - 1) / x is equivalent to M(Pi), 
      // which is ceil(Pi / x) - 1
      total_moves += (Pi - 1) / x;
    }
    ret = min(ret, total_moves + x);
  }
  return ret;
}
</pre>

<p>&quot;Whooa! Run it, run it!&quot; you exclaim.</p>

<p>&quot;Hold on, hold on. Although the algorithm above is fast enough to solve our problem, I have an even faster algorithm. Notice that the list of <b>ceil(a/1), ceil(a/2), ...</b> only changes values at most <b>2*sqrt(a)</b> times. For example, if <b>a=10</b>, the list is: <b>10, 5, 3, 3, 2, 2, 2, 2, 2, 1, 1, ...</b>. That list only changes value <b>4</b> times which is less than <b>2 * sqrt(10)</b>! Therefore, we can precompute when the list changes value for every diner in only <b>O(D*sqrt(M))</b>. We can keep track these value changes in a table. For example, if <b>P<sub>i</sub>=10</b>, we can have a table <b>T<sub>i</sub></b>: <b>10, -5, -2, 0, -1, 0, 0, 0, 0, -1, 0, ...</b>. Notice that the prefix sum of this table is actually: <b>10, 5, 3, 3, 2, 2, 2, ...</b>. More importantly, this table is sparse, i.e. it has only <b>O(sqrt(M))</b> non-zeroes. If we do vector addition on all <b>T<sub>i</sub></b>, we can get a table where every entry at index <b>x</b> of the prefix sum contains sum of <b>ceil(P<sub>i</sub>/x)</b>. Then, we can calculate sum of <b>ceil(P<sub>i</sub>/x)-1</b> in the code above by subtracting the <b>x<sup>th</sup></b> index of the prefix sum with the number of diners. Hence, only another <b>O(M)</b> pass is needed to calculate candidate answers, which gives us <b>O(D*sqrt(M) + M)</b> running time. A much faster solution!&quot;</p>

<blockquote>&quot;One more thing, we cannot do binary search or ternary search, at least in trivial ways, on a function that maps <b>x</b> to its minimum breakfast end time as the function can have multiple minimas. e.g. for <b>2</b> diners with <b>9</b> pancakes each, the function forms the following mappings: <b>(1,17), (2,10), (3,7), (4,8), (5,7), (6,8), (7,9), (8,10), (9,9)</b>.&quot;</blockquote>

<p>&quot;I don&#39;t need that! The previous algorithm is fast enough. Please run it,&quot; you say impatiently.</p>

<p>&quot;Sigh. I won&#39;t tell you how to code the faster solution then. The answer is...&quot; Everyone gasps while the program blinks. &quot;... <b>42</b>."</p>

  <div class="test-data-download-wrapper">
    <div class="test-data-download-header">
      <div class="test-data-download-header-text">Test Data</div>
      <div class="test-data-download-header-download-button">
        <a href="test_data.zip" target="_blank">
          <i class="material-icons grey">save_alt</i>
        </a>
      </div>
    </div>
    <div class="test-data-download-content">
      <div class="test-data-download-warning">
        <span class="material-icons" style="color: grey; vertical-align: middle;">info</span>
        <span style="vertical-align: middle;">We recommend that you practice debugging solutions without looking at the test data.</span>
      </div>
    </div>
  </div>



    </div>
  </body>
</html>
