
<html>
  <head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/external_hosted/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML,Safe"></script>
    <script>
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
          inlineMath: [ ['$$$','$$$'] ],
          displayMath: [ ['$$$$','$$$$'] ],
          skipTags: ["script","noscript","style","textarea","pre"],  // allow <code>.
          processEscapes: true
        },
        showProcessingMessages: false,
        messageStyle: "none",
        "HTML-CSS": { scale: 90, fonts: ["TeX"] }
      });
      MathJax.Ajax.loadComplete('https://codingcompetitions.withgoogle.com/static/mathjax-config.js');
      </script>
    <style>
.problem-io-wrapper-new .sampleio-wrapper {
  display: flex;
  flex-direction: row;
  align-items: stretch;
  justify-content: flex-start;
  margin-top: 1rem;
  padding-left: 12.5px;
  padding-right: 12.5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-input {
  display: flex;
  flex-direction: column;
  flex: 1 1 0px;
  margin-left: -12.5px;
  margin-right: 12.5px;
  max-width: 50%;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-output {
  display: flex;
  flex-direction: column;
  flex: 1 1 0px;
  margin-left: 12.5px;
  margin-right: -12.5px;
  max-width: 50%;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-text {
  flex: 1;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-download-button {
  display: none;
  cursor: pointer;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button {
  display: none;
  cursor: pointer;
  position: relative;
  margin-left: 5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup {
  visibility: hidden;
  width: 100px;
  background-color: #999;
  color: #fff;
  text-align: center;
  border-radius: 3px;
  padding: 4px 0;
  position: absolute;
  z-index: 1;
  top: 125%;
  left: 50%;
  margin-left: -50px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup::before {
  content: "";
  position: absolute;
  bottom: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: transparent transparent #999 transparent;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup-shown {
  visibility: visible;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button-hidden {
  display: none;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-content {
  display: flex;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #f5f5f5;
  padding: 9.5px 9.5px 0px 9.5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-content .sample-content-text {
  flex-grow: 1;
  margin: 0px;
  overflow-x: auto;
  padding-bottom: 9.5px;
  line-height: normal;
  white-space: pre-wrap;
}
.test-data-download-wrapper {
  display: none;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  width: fit-content;
  max-width: 600px;
  margin-top: 1rem;
}
.test-data-download-wrapper .test-data-download-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.test-data-download-wrapper .test-data-download-header .test-data-download-header-text {
  flex: 1;
}
.test-data-download-wrapper .test-data-download-header .test-data-download-header-download-button {
  display: none;
  cursor: pointer;
}
.test-data-download-wrapper .test-data-download-content {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #f5f5f5;
  padding: 9.5px 9.5px 9.5px 9.5px;
}
.sample-interaction-wrapper {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  max-width: 600px;
  margin-top: 1rem;
}
.sample-interaction-wrapper .sample-interaction-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.sample-interaction-wrapper .sample-interaction-header .sample-interaction-text {
  flex: 1;
}
.sample-interaction-wrapper .sample-interaction-content {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #e6e6e6;
  padding: 9.5px 9.5px 9.5px 9.5px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels {
  display: flex;
  flex-direction: row;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels .sample-interaction-judge-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: left;
  flex-grow: 1;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels .sample-interaction-solution-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: right;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper {
  display: flex;
  flex-direction: row;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper .sample-interaction-judge-output-box {
  text-align: start;
  background: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 4px 8px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper .sample-interaction-judge-output-box .sample-interaction-judge-output-test {
  margin: 0;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper {
  display: flex;
  flex-direction: row-reverse;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper .sample-interaction-solution-output-box {
  text-align: start;
  background: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 4px 8px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper .sample-interaction-solution-output-box .sample-interaction-solution-output-test {
  margin: 0;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-note {
  font-style: italic;
  color: #4e4e4e;
  margin-right: 20%;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-note {
  font-style: italic;
  color: #4e4e4e;
  margin-left: 20%;
  text-align: end;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-block-section-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: center;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-block-spacer {
  height: 9.5px;
}
    </style>
  </head>
  <body>
    <div>
<h3>Code Jam 2008 - AMER Semifinal</h3><h1>Analysis: King</h1><p>
  The problem corresponds to a relatively unknown game named Slither. This game
  was popularized by Martin Gardner in one of his columns written for Scientific
  American. It wasn't solved then, but eventually William Anderson developed a
  solution. Of course Code Jam participants are much smarter, so we thought the
  problem would easily get solved in two hours.
</p><p>
  I'll explain first the solution for a simpler variant of the problem. Suppose
  we have a <i>3x3</i> board with the king being in one of the corner cells. Now
  let's cover the rest of the board with dominoes of size <i>2x1</i>. This
  tiling of the board shows us a winning strategy for the second player. Each
  time the first player moves to one cell of a domino, the second player will
  move to the other cell of that domino. Since the second player can always make
  a move after the first player moves, the second player has a winning strategy.
</p><p>
  The general solution goes along the same lines: the domino tiling corresponds
  to a maximum matching. We think of the board as a graph where the cells are
  the nodes, and neighboring cells have edges between them. The dominoes, then,
  correspond to edges in the maximum matching.
</p><p>
  The solution is given by the following theorem:
  <i>
    "The first player has a winning strategy if and only if all maximum
    matchings contain the king's node"
  </i>.
</p><p>
  This means that no alternating path starting from the king's node ends in a
  vertex that is not in the matching, because if it ended in a unmatched vertex
  we could construct another matching with the same number of edges that doesn't
  use the king's node. Thus the first player could always move along a matched
  edge.
</p><p>
  If there is a maximum matching that doesn't contain the king's node, then in
  this graph every alternating path that starts from the kings node ends in a
  matched node, otherwise we could increase the size of the matching which
  contradicts the assumption that the matching is maximum. Thus now the second
  player can always move in the second node of the matching edges. So the second
  player has a winning strategy.
</p><p>
  The graph in our problem is not bipartite so we can't use the standard
  algorithm for bipartite matching. Instead we use a solution that combines
  brute force and dynamic programming. Our solution will be exponential rather
  than polynomial, but the size of the problem is small so we can afford it. We
  go row by row from left to right, and for each cell <i>(i, j)</i> and each
  subset <i>S</i> of <i>{0, 1, .. n - 1}</i> we compute the best matching that
  has the following nodes matched already: nodes on the active line
  (<i>[i][0..j], [i-1][j+1 .. n - 1]</i>) that correspond to the numbers in
  <i>S</i>, and matched nodes from before the active line.
</p><p>
  Here's Derek Kisman's code that implements this solution:
</p>
<pre>
#include &lt;algorithm&gt;
#include &lt;iostream&gt;
using namespace std;

int gx, gy;
char g[15][15];

char memo[15][15][1&lt;&lt;16];
char doit(int x, int y, int b) {
  if (x == gx) {
    x = 0;
    if (++y == gy) return 0;
  }
  char&amp; ret = memo[x][y][b];
  if (ret != -1) return ret;
  int b2 = (b&lt;&lt;1) &amp; ((1&lt;&lt;(gx+1))-1);
  if (g[y][x] != '.') {
    ret = doit(x+1, y, b2);
  } else {
    ret = doit(x+1, y, b2+1);
    if (x &amp;&amp; (b&amp;1)) ret &gt;?= 1 + doit(x+1, y, b2-2);
    if (x &amp;&amp; (b&amp;(1&lt;&lt;gx)))
      ret &gt;?= 1 + doit(x+1, y, b2);
    if (b&amp;(1&lt;&lt;(gx-1)))
      ret &gt;?= 1 + doit(x+1, y, b2-(1&lt;&lt;gx));
    if (x &lt; gx-1 &amp;&amp; (b&amp;(1&lt;&lt;(gx-2))))
      ret &gt;?= 1 + doit(x+1, y, b2-(1&lt;&lt;(gx-1)));
  }
  return ret;
}

main() {
  int N, prob=1;
  for (cin &gt;&gt; N; N--;) {
    cin &gt;&gt; gy &gt;&gt; gx;
    int kx, ky;
    for (int y = 0; y &lt; gy; y++)
    for (int x = 0; x &lt; gx; x++) {
      cin &gt;&gt; g[y][x];
      if (g[y][x] == 'K') {kx = x; ky = y;}
    }
    memset(memo, -1, sizeof(memo));
    int m1 = doit(0, 0, 0);
    g[ky][kx] = '.';
    memset(memo, -1, sizeof(memo));
    int m2 = doit(0, 0, 0);
    cout &lt;&lt; "Case #" &lt;&lt; prob++
         &lt;&lt; ": " &lt;&lt; ((m2 &gt; m1) ? 'A' : 'B')
         &lt;&lt; endl;
  }
}
</pre>


  <div class="test-data-download-wrapper">
    <div class="test-data-download-header">
      <div class="test-data-download-header-text">Test Data</div>
      <div class="test-data-download-header-download-button">
        <a href="test_data.zip" target="_blank">
          <i class="material-icons grey">save_alt</i>
        </a>
      </div>
    </div>
    <div class="test-data-download-content">
      <div class="test-data-download-warning">
        <span class="material-icons" style="color: grey; vertical-align: middle;">info</span>
        <span style="vertical-align: middle;">We recommend that you practice debugging solutions without looking at the test data.</span>
      </div>
    </div>
  </div>



    </div>
  </body>
</html>
