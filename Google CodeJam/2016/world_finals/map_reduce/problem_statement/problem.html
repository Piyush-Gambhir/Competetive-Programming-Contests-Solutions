
<html>
  <head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://www.gstatic.com/external_hosted/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML,Safe"></script>
    <script>
      MathJax.Hub.Config({
        extensions: ["tex2jax.js"],
        jax: ["input/TeX", "output/HTML-CSS"],
        tex2jax: {
          inlineMath: [ ['$$$','$$$'] ],
          displayMath: [ ['$$$$','$$$$'] ],
          skipTags: ["script","noscript","style","textarea","pre"],  // allow <code>.
          processEscapes: true
        },
        showProcessingMessages: false,
        messageStyle: "none",
        "HTML-CSS": { scale: 90, fonts: ["TeX"] }
      });
      MathJax.Ajax.loadComplete('https://codingcompetitions.withgoogle.com/static/mathjax-config.js');
      </script>
    <style>
.problem-io-wrapper-new .sampleio-wrapper {
  display: flex;
  flex-direction: row;
  align-items: stretch;
  justify-content: flex-start;
  margin-top: 1rem;
  padding-left: 12.5px;
  padding-right: 12.5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-input {
  display: flex;
  flex-direction: column;
  flex: 1 1 0px;
  margin-left: -12.5px;
  margin-right: 12.5px;
  max-width: 50%;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-output {
  display: flex;
  flex-direction: column;
  flex: 1 1 0px;
  margin-left: 12.5px;
  margin-right: -12.5px;
  max-width: 50%;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-text {
  flex: 1;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-download-button {
  display: none;
  cursor: pointer;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button {
  display: none;
  cursor: pointer;
  position: relative;
  margin-left: 5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup {
  visibility: hidden;
  width: 100px;
  background-color: #999;
  color: #fff;
  text-align: center;
  border-radius: 3px;
  padding: 4px 0;
  position: absolute;
  z-index: 1;
  top: 125%;
  left: 50%;
  margin-left: -50px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup::before {
  content: "";
  position: absolute;
  bottom: 100%;
  left: 50%;
  margin-left: -5px;
  border-width: 5px;
  border-style: solid;
  border-color: transparent transparent #999 transparent;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button .sample-header-copy-popup-shown {
  visibility: visible;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-header .sample-header-copy-button-hidden {
  display: none;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-content {
  display: flex;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #f5f5f5;
  padding: 9.5px 9.5px 0px 9.5px;
}
.problem-io-wrapper-new .sampleio-wrapper .sample-content .sample-content-text {
  flex-grow: 1;
  margin: 0px;
  overflow-x: auto;
  padding-bottom: 9.5px;
  line-height: normal;
  white-space: pre-wrap;
}
.test-data-download-wrapper {
  display: none;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  width: fit-content;
  max-width: 600px;
  margin-top: 1rem;
}
.test-data-download-wrapper .test-data-download-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.test-data-download-wrapper .test-data-download-header .test-data-download-header-text {
  flex: 1;
}
.test-data-download-wrapper .test-data-download-header .test-data-download-header-download-button {
  display: none;
  cursor: pointer;
}
.test-data-download-wrapper .test-data-download-content {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #f5f5f5;
  padding: 9.5px 9.5px 9.5px 9.5px;
}
.sample-interaction-wrapper {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  max-width: 600px;
  margin-top: 1rem;
}
.sample-interaction-wrapper .sample-interaction-header {
  display: flex;
  flex-direction: row;
  border-left: 1px solid #ccc;
  border-right: 1px solid #ccc;
  border-top: 1px solid #ccc;
  border-radius: 4px 4px 0px 0px;
  padding: 9.5px 9.5px 7px 9.5px;
  font-family: 'Google Sans';
  font-size: 1.2rem;
  font-weight: 300;
}
.sample-interaction-wrapper .sample-interaction-header .sample-interaction-text {
  flex: 1;
}
.sample-interaction-wrapper .sample-interaction-content {
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  border: 1px solid #ccc;
  border-radius: 0px 0px 4px 4px;
  background-color: #e6e6e6;
  padding: 9.5px 9.5px 9.5px 9.5px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels {
  display: flex;
  flex-direction: row;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels .sample-interaction-judge-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: left;
  flex-grow: 1;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-solution-labels .sample-interaction-solution-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: right;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper {
  display: flex;
  flex-direction: row;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper .sample-interaction-judge-output-box {
  text-align: start;
  background: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 4px 8px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-output-wrapper .sample-interaction-judge-output-box .sample-interaction-judge-output-test {
  margin: 0;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper {
  display: flex;
  flex-direction: row-reverse;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper .sample-interaction-solution-output-box {
  text-align: start;
  background: #f5f5f5;
  border: 1px solid #ccc;
  border-radius: 8px;
  padding: 4px 8px;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-output-wrapper .sample-interaction-solution-output-box .sample-interaction-solution-output-test {
  margin: 0;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-judge-note {
  font-style: italic;
  color: #4e4e4e;
  margin-right: 20%;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-solution-note {
  font-style: italic;
  color: #4e4e4e;
  margin-left: 20%;
  text-align: end;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-block-section-label {
  font-weight: bold;
  color: #4e4e4e;
  text-align: center;
}
.sample-interaction-wrapper .sample-interaction-content .sample-interaction-block-spacer {
  height: 9.5px;
}
    </style>
  </head>
  <body>
    <div>
<h3>Code Jam 2016 - World Finals</h3><h1>Map Reduce</h1><h3>Problem</h3>

<p>
Ben the brilliant video game designer is trying to design maps for his upcoming
augmented-reality mobile game. Recently, he has created a map which is
represented as a matrix of <b>R</b> rows and <b>C</b> columns. The map consists
of a bunch of <code>.</code> characters representing empty squares, a bunch of
<code>#</code> characters representing impassable walls, a single start position
represented by <code>S</code> and a single finish position represented by
<code>F</code>. For example, the map could look like:
</p>
<pre>
#############
#S..#..##...#
###.##..#.#F#
#...##.##.###
#.#.........#
#############
</pre>

<p>
In Ben's game, a <i>path</i> is a sequence of steps (up, down, left or right)
to go from one cell to another while not going through any impassable walls.
</p>

<p>
Ben considers a <i>good</i> map to have the following properties:
</p>

<ul>
<li>There is a path between any two empty squares (including the start and
finish positions).</li>
<li>To preserve structural integrity, impassable walls must meet at edges and
not just corners. For every 2&times;2 region in the map, if the region contains
exactly two walls, then those walls are either in the same row or the same
column. In other words, there is no 2&times;2 region where the walls are in one
of these two configurations:
<br/>
<p>
<code>
#.&nbsp;&nbsp;&nbsp;.#<br>
.#&nbsp;&nbsp;&nbsp;#.<br>
</code>
</p>
</li>
<li>The boundary consists of only impassable walls. A cell is considered part
of the boundary if it is in the uppermost/lowermost rows or if it is in the
leftmost/rightmost columns.</li>
</ul>

<p>
The distance of the shortest path is the minimum number of steps required to
reach the finish position from the start position. For instance, the shortest
path in the above example takes 17 steps.
</p>

<p>
Being such a clever mapmaker, Ben realized that he has created a map that is too
hard for his friends to solve. He would like to reduce its difficulty by
removing some of the impassable walls. In particular, he wants to know whether
it is possible to remove zero or more impassable walls from his map such that
the shortest path from start to finish takes <i>exactly</i> <b>D</b> steps, and
that the resulting map is still <i>good</i>. Note that it is not enough to
simply find <i>a</i> path with <b>D</b> steps; <b>D</b> must be the number of
steps in the <i>shortest</i> path.
</p>

<p>
For example, if <b>D</b> = 15, we could remove the impassable wall directly
below the finish position to get a good solution.
</p>

<pre>
#############
#S..#..##...#
###.##..#.#F#
#...##.##.#.#
#.#.........#
#############
</pre>

<p>
There is no solution if <b>D</b> = 5.
</p>

<h3>Input</h3>

<p>
The first line of the input gives the number of test cases, <b>T</b>. <b>T</b>
test cases follow. Each test case starts with a line containing three
space-separated integers <b>R</b>, <b>C</b> and <b>D</b>: the number of rows and
columns in the map, and the desired number of steps in the shortest path from
start to finish after possibly removing impassable walls. <b>R</b> lines follow,
each consisting of <b>C</b> characters (either <code>.</code>, <code>#</code>,
<code>S</code> or <code>F</code>) representing Ben's map.
</p>

<p>
It is guaranteed that the map is good, as described in the problem statement.
</p>

<h3>Output</h3>
<p>
For each test case, output one line containing <code>Case #x: y</code>, where
<code>x</code> is the test case number (starting from 1) and <code>y</code> is
the word <code>POSSIBLE</code> or <code>IMPOSSIBLE</code>, depending on whether
the shortest path can be made equal to <b>D</b> by removing some number of walls
such that the map is still good. If it is possible, output <b>R</b> more lines
containing <b>C</b> characters each, representing the new map. In your output,
replace the <code>#</code> characters for removed walls (if any) with
<code>.</code> characters.
</p>

<p>
If multiple solutions are possible, you may output any of them.
</p>

<h3>Limits</h3>
<p>
Memory limit: 1 GB.<br/>
1 &le; <b>T</b> &le; 100.<br/>
Each test case contains exactly one <code>S</code> and exactly one <code>F</code>.<br/>
The input file is at most 3MB in size.
</p>

<h4>Small dataset (Test Set 1 - Visible)</h4>
<p>
Time limit: 60 seconds.<br/>
3 &le; <b>R</b> &le; 40.<br/>
3 &le; <b>C</b> &le; 40.<br/>
1 &le; <b>D</b> &le; 1600.<br/>
</p>

<h4>Large dataset (Test Set 2 - Hidden)</h4>
<p>
Time limit: 300 seconds.<br/>
3 &le; <b>R</b> &le; 1000.<br/>
3 &le; <b>C</b> &le; 1000.<br/>
1 &le; <b>D</b> &le; 10<sup>6</sup>.<br/>
</p>

<p><b>NOTE:</b> The Large output breaks the usual cap on Code Jam output size,
but you can upload it as normal.
</p>


  <h3>Sample</h3>
  <div class="problem-io-wrapper-new">
    <div class="sampleio-wrapper">
      <div class="sample-input">
        <div class="sample-header">
          <div class="sample-header-text">Sample Input</div>
          <div class="sample-header-download-button">
            <a href="map_reduce_sample_ts1_input.txt" target="_blank" aria-label="Download">
              <i class="material-icons grey">save_alt</i>
            </a>
          </div>
          <div class="sample-header-copy-button" onclick="
              const copyText = document.getElementById('sample_input_0').textContent;
              const textArea = document.createElement('textarea');
              textArea.textContent = copyText;
              textArea.style.position = 'absolute';
              textArea.style.left = '-100%';
              document.body.append(textArea);
              textArea.select();
              document.execCommand('copy');
              textArea.remove();
              const copyPopup = document.getElementById('sample_input_copy_popup_0');
              copyPopup.classList.add('sample-header-copy-popup-shown');
              setTimeout(function(){ copyPopup.classList.remove('sample-header-copy-popup-shown'); }, 2000);
          " aria-label="Copy to clipboard">
            <i class="material-icons grey">content_copy</i>
            <span class="sample-header-copy-popup" id="sample_input_copy_popup_0">
              Copied!
            </span>
          </div>
        </div>
        <div class="sample-content">
          <pre class="sample-content-text" id="sample_input_0">3
6 13 15
#############
#S..#..##...#
###.##..#.#F#
#...##.##.###
#.#.........#
#############
5 8 3
########
#S.....#
####...#
#F.....#
########
4 10 11
##########
#S#...#.F#
#...#...##
##########
</pre>
        </div>
      </div>
      <div class="sample-output">
        <div class="sample-header">
          <div class="sample-header-text">Sample Output</div>
          <div class="sample-header-download-button">
            <a href="map_reduce_sample_ts1_output.txt" target="_blank" aria-label="Download">
              <i class="material-icons grey">save_alt</i>
            </a>
          </div>
          <div class="sample-header-copy-button" onclick="
              const copyText = document.getElementById('sample_output_0').textContent;
              const textArea = document.createElement('textarea');
              textArea.textContent = copyText;
              textArea.style.position = 'absolute';
              textArea.style.left = '-100%';
              document.body.append(textArea);
              textArea.select();
              document.execCommand('copy');
              textArea.remove();
              const copyPopup = document.getElementById('sample_output_copy_popup_0');
              copyPopup.classList.add('sample-header-copy-popup-shown');
              setTimeout(function(){ copyPopup.classList.remove('sample-header-copy-popup-shown'); }, 2000);
          " aria-label="Copy to clipboard">
            <i class="material-icons grey">content_copy</i>
            <span class="sample-header-copy-popup" id="sample_output_copy_popup_0">
              Copied!
            </span>
          </div>
        </div>
        <div class="sample-content">
          <pre class="sample-content-text" id="sample_output_0">Case #1: POSSIBLE
#############
#S..#..##...#
###.##..#.#F#
#...##.##.#.#
#.#.........#
#############
Case #2: IMPOSSIBLE
Case #3: POSSIBLE
##########
#S#...#.F#
#...#...##
##########
</pre>
        </div>
      </div>
    </div>
  </div>


<p>
The sample output displays one set of answers to the sample cases. Other
answers may be possible.
</p>

<p>
Sample case #1 is the example in the problem statement.
</p>

<p>
In sample case #2, it is possible to remove walls to make the distance of the
shortest path either 2 or 4, for example. However, there is no way to make the
distance of the shortest path exactly 3.
</p>

<p>
In sample case #3, the shortest path already takes 11 steps to begin with, so
there is no need to reduce the difficulty of the map.
</p>

    </div>
  </body>
</html>
